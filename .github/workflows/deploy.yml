# .github/workflows/deploy.yml
name: PF | Despliegue de Infraestructura y Configuración (GitOps)

# CRÍTICO: El workflow se ejecuta manualmente
on:
  workflow_dispatch:

env:
  # Credenciales de AWS
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }} # 'us-east-1' o la región que uses

  # Credenciales de la Base de Datos (para Terraform y Ansible)
  DB_NAME: "wordpress" # Coincide con el default o el valor que uses en variables.tf
  DB_USER: ${{ secrets.DB_USER }} # Secretos requeridos
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }} # Secretos requeridos

  # Llave SSH Privada para Ansible (Requerida por el proveedor ec2 de Ansible)
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  
jobs:
  # =================================================================
  # 1. VALIDACIÓN (LINTING Y FORMATO)
  # =================================================================
  validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      # --- Validación de Terraform ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.x
      
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check
        working-directory: ./terraform
      
      # --- Validación de Ansible ---
      - name: Instalar Ansible
        run: pip install ansible
        
      - name: Ansible Lint (Validación de sintaxis del Playbook)
        run: ansible-lint -c .ansible-lint deploy.yml
        working-directory: ./ansible # Ajusta si tu playbook está en otra ruta

  # =================================================================
  # 2. DESPLIEGUE DE INFRAESTRUCTURA (TERRAFORM)
  # =================================================================
  terraform_deploy:
    needs: validation
    runs-on: ubuntu-latest
    outputs:
      rds_endpoint: ${{ steps.output.outputs.rds_endpoint }} # Exportar el endpoint
      
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.x
          
      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Plan
        id: plan
        run: terraform plan -var="db_name=${{ env.DB_NAME }}" -var="db_username=${{ env.DB_USER }}" -var="db_password=${{ env.DB_PASSWORD }}"
        working-directory: ./terraform

      - name: Terraform Apply
        id: apply
        # Ejecutar la aplicación, pasando los secretos de DB como variables
        run: terraform apply -auto-approve -var="db_name=${{ env.DB_NAME }}" -var="db_username=${{ env.DB_USER }}" -var="db_password=${{ env.DB_PASSWORD }}"
        working-directory: ./terraform
        
      - name: Get Terraform Outputs (RDS Endpoint)
        id: output
        run: |
          RDS_ENDPOINT=$(terraform output -raw rds_endpoint)
          echo "rds_endpoint=$RDS_ENDPOINT" >> $GITHUB_OUTPUT
        working-directory: ./terraform

  # =================================================================
  # 3. CONFIGURACIÓN DE APLICACIÓN (ANSIBLE)
  # =================================================================
  ansible_config:
    needs: terraform_deploy # Asegura que la infra se haya creado
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Setup Python and Install Ansible
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install Dependencies
        run: |
          pip install ansible boto3 botocore

      - name: Guardar la llave SSH privada
        # Esto guarda la llave en el runner para que Ansible la use para conectarse a las EC2
        run: |
          echo "${{ env.EC2_SSH_PRIVATE_KEY }}" > ansible_ssh_key.pem
          chmod 600 ansible_ssh_key.pem
      
      - name: Wait for ASG instances to become ready
        # Espera brevemente a que las instancias se lancen y el ASG las registre.
        run: sleep 60 

      - name: Ejecutar Playbook de Ansible
        env:
          # Pasar el RDS_ENDPOINT (output de Terraform) a Ansible
          RDS_ENDPOINT: ${{ needs.terraform_deploy.outputs.rds_endpoint }}
        run: |
          ansible-playbook -i ansible/aws_ec2.yml \
            --private-key ansible_ssh_key.pem \
            -e "DB_NAME=${{ env.DB_NAME }}" \
            -e "DB_USER=${{ env.DB_USER }}" \
            -e "DB_PASSWORD=${{ env.DB_PASSWORD }}" \
            ansible/deploy.yml
        # CRÍTICO: Ajustar la ruta del inventario y del playbook si es necesario.
        # Asumo que tu carpeta Ansible está en la raíz.
